enum Val {A, B, C}

pub fn test() {
    test_value = {v=[A,A]; v += [B] + [C] + [A]; "{v}"};
    assert(
        test_value == "[A,A,B,C,A]",
        "Test failed {test_value} != \"[A,A,B,C,A]\""
    );
}
Type 17:Val[1]:Enum(["A", "B", "C"])

Type 18:main_vector<Val>[8]:
    vector:vector<Val>[4]

Type 19:vector<Val>[4]:Vector(17)

fn test() {#block(1):void
  __ref_3(1):ref(main_vector<Val>) = null;
  __ref_2(1):ref(main_vector<Val>) = null;
  __ref_1(1):ref(main_vector<Val>) = null;
  __work_2(1):text = "";
  __work_1(1):text = "";
  [4] test_value(1):text["__work_1"] = {#block(2):text["__work_1"]
    OpDatabase(__ref_1(1), 18i32);
    v(2):vector<Val>["__ref_1"] = OpGetField(__ref_1(1), 4i32, 19i32);
    OpSetInt(__ref_1(1), 4i32, 0i32);
    _elm_1(2):ref(boolean)["v"] = OpNewRecord(v(2), 19i32, 65535i32);
    OpSetEnum(_elm_1(2), 0i32, 1u8(17));
    OpFinishRecord(v(2), _elm_1(2), 19i32, 65535i32);
    _elm_1(2):ref(boolean)["v"] = OpNewRecord(v(2), 19i32, 65535i32);
    OpSetEnum(_elm_1(2), 0i32, 1u8(17));
    OpFinishRecord(v(2), _elm_1(2), 19i32, 65535i32);
    _elm_2(2):ref(boolean)["v"] = OpNewRecord(v(2), 19i32, 65535i32);
    OpSetEnum(_elm_2(2), 0i32, 2u8(17));
    OpFinishRecord(v(2), _elm_2(2), 19i32, 65535i32);
    OpAppendVector(v(2), {#Vector(3):vector<Val>
      OpDatabase(__ref_2(1), 18i32);
      _vec_3(3):vector<Val>["__ref_2"] = OpGetField(__ref_2(1), 4i32, 19i32);
      OpSetInt(__ref_2(1), 4i32, 0i32);
      _elm_4(3):ref(boolean)["_vec_3"] = OpNewRecord(_vec_3(3), 19i32, 65535i32);
      OpSetEnum(_elm_4(3), 0i32, 3u8(17));
      OpFinishRecord(_vec_3(3), _elm_4(3), 19i32, 65535i32);
      _vec_3(3);
    }#Vector(3):vector<Val>, 17i32);
    OpAppendVector(v(2), {#Vector(4):vector<Val>
      OpDatabase(__ref_3(1), 18i32);
      _vec_5(4):vector<Val>["__ref_3"] = OpGetField(__ref_3(1), 4i32, 19i32);
      OpSetInt(__ref_3(1), 4i32, 0i32);
      _elm_6(4):ref(boolean)["_vec_5"] = OpNewRecord(_vec_5(4), 19i32, 65535i32);
      OpSetEnum(_elm_6(4), 0i32, 1u8(17));
      OpFinishRecord(_vec_5(4), _elm_6(4), 19i32, 65535i32);
      _vec_5(4);
    }#Vector(4):vector<Val>, 17i32);
    {#Formatted string(5):text["__work_1"]
      __work_1(1):text = "";
      OpFormatDatabase(__work_1(1), v(2), 19i32, false);
      __work_1(1);
    }#Formatted string(5):text["__work_1"];
  }#block(2):text["__work_1"];
  [5] if OpEqText(test_value(1), "[A,A,B,C,A]") null else OpPanic({#Formatted string(6):text["__work_2"]
    __work_2(1):text = "Test failed ";
    OpFormatText(__work_2(1), test_value(1), 0i32, -1i32, 32i32);
    OpAppendText(__work_2(1), " != "[A,A,B,C,A]"");
    __work_2(1);
  }#Formatted string(6):text["__work_2"]);
  OpFreeText(test_value(1));
  OpFreeRef(__ref_1(1));
  OpFreeText(__work_1(1));
  OpFreeText(__work_2(1));
  OpFreeRef(__ref_2(1));
  OpFreeRef(__ref_3(1));
}#block(1):void

byte-code for append_vector:test()
   0[0]: return-address
   0[4]: ConvRefFromNull() -> ref(reference) var=__ref_3[4]:ref(main_vector<Val>)
   1[16]: ConvRefFromNull() -> ref(reference) var=__ref_2[16]:ref(main_vector<Val>)
   2[28]: ConvRefFromNull() -> ref(reference) var=__ref_1[28]:ref(main_vector<Val>)
   3[40]: Text() var=__work_2[40]:text
   4[64]: Text() var=__work_1[64]:text
   5[88]: [4] Text() var=test_value[88]:text["__work_1"]
   6[112]: Database(var[28], db_tp=18) type=main_vector<Val>[8]:{vector:vector<Val>[4]}[18]
  11[112]: VarRef(var[28]) -> ref(reference) type=main_vector<Val>[8]:{vector:vector<Val>[4]}[18] var=__ref_1[28]:ref(main_vector<Val>)
  14[124]: GetField(v1: ref(reference), fld=4) -> ref(reference) type=vector<Val>[4]:Vector(17)[19]
  17[124]: VarRef(var[28]) -> ref(reference) type=main_vector<Val>[8]:{vector:vector<Val>[4]}[18] var=__ref_1[28]:ref(main_vector<Val>)
  20[136]: ConstInt(val=0) -> integer
  25[140]: SetInt(v1: ref(reference), fld=4, val: integer)
  28[124]: VarVector(var[112]) -> vector type=vector<Val>[4]:Vector(17)[19] var=v[112]:vector<Val>["__ref_1"]
  31[136]: NewRecord(data: ref(reference), parent_tp=19, fld=65535) -> ref(reference)
  36[136]: VarRef(var[124]) -> ref(reference) type=boolean[1]:Base[4] var=_elm_1[124]:ref(boolean)["v"]
  39[148]: ConstEnum(val=1) -> boolean type=Val[1]:Enum(["A", "B", "C"])[17]
  41[149]: SetEnum(v1: ref(reference), fld=0, val: boolean)
  44[136]: VarVector(var[112]) -> vector type=vector<Val>[4]:Vector(17)[19] var=v[112]:vector<Val>["__ref_1"]
  47[148]: VarRef(var[124]) -> ref(reference) type=boolean[1]:Base[4] var=_elm_1[124]:ref(boolean)["v"]
  50[160]: FinishRecord(data: ref(reference), rec: ref(reference), parent_tp=19, fld=65535)
  55[136]: VarVector(var[112]) -> vector type=vector<Val>[4]:Vector(17)[19] var=v[112]:vector<Val>["__ref_1"]
  58[148]: NewRecord(data: ref(reference), parent_tp=19, fld=65535) -> ref(reference)
  63[148]: PutRef(var[124], value: ref(reference))
  66[136]: VarRef(var[124]) -> ref(reference) type=boolean[1]:Base[4] var=_elm_1[124]:ref(boolean)["v"]
  69[148]: ConstEnum(val=1) -> boolean type=Val[1]:Enum(["A", "B", "C"])[17]
  71[149]: SetEnum(v1: ref(reference), fld=0, val: boolean)
  74[136]: VarVector(var[112]) -> vector type=vector<Val>[4]:Vector(17)[19] var=v[112]:vector<Val>["__ref_1"]
  77[148]: VarRef(var[124]) -> ref(reference) type=boolean[1]:Base[4] var=_elm_1[124]:ref(boolean)["v"]
  80[160]: FinishRecord(data: ref(reference), rec: ref(reference), parent_tp=19, fld=65535)
  85[136]: VarVector(var[112]) -> vector type=vector<Val>[4]:Vector(17)[19] var=v[112]:vector<Val>["__ref_1"]
  88[148]: NewRecord(data: ref(reference), parent_tp=19, fld=65535) -> ref(reference)
  93[148]: VarRef(var[136]) -> ref(reference) type=boolean[1]:Base[4] var=_elm_2[136]:ref(boolean)["v"]
  96[160]: ConstEnum(val=2) -> boolean type=Val[1]:Enum(["A", "B", "C"])[17]
  98[161]: SetEnum(v1: ref(reference), fld=0, val: boolean)
 101[148]: VarVector(var[112]) -> vector type=vector<Val>[4]:Vector(17)[19] var=v[112]:vector<Val>["__ref_1"]
 104[160]: VarRef(var[136]) -> ref(reference) type=boolean[1]:Base[4] var=_elm_2[136]:ref(boolean)["v"]
 107[172]: FinishRecord(data: ref(reference), rec: ref(reference), parent_tp=19, fld=65535)
 112[148]: VarVector(var[112]) -> vector type=vector<Val>[4]:Vector(17)[19] var=v[112]:vector<Val>["__ref_1"]
 115[160]: Database(var[16], db_tp=18) type=main_vector<Val>[8]:{vector:vector<Val>[4]}[18]
 120[160]: VarRef(var[16]) -> ref(reference) type=main_vector<Val>[8]:{vector:vector<Val>[4]}[18] var=__ref_2[16]:ref(main_vector<Val>)
 123[172]: GetField(v1: ref(reference), fld=4) -> ref(reference) type=vector<Val>[4]:Vector(17)[19]
 126[172]: VarRef(var[16]) -> ref(reference) type=main_vector<Val>[8]:{vector:vector<Val>[4]}[18] var=__ref_2[16]:ref(main_vector<Val>)
 129[184]: ConstInt(val=0) -> integer
 134[188]: SetInt(v1: ref(reference), fld=4, val: integer)
 137[172]: VarVector(var[160]) -> vector type=vector<Val>[4]:Vector(17)[19] var=_vec_3[160]:vector<Val>["__ref_2"]
 140[184]: NewRecord(data: ref(reference), parent_tp=19, fld=65535) -> ref(reference)
 145[184]: VarRef(var[172]) -> ref(reference) type=boolean[1]:Base[4] var=_elm_4[172]:ref(boolean)["_vec_3"]
 148[196]: ConstEnum(val=3) -> boolean type=Val[1]:Enum(["A", "B", "C"])[17]
 150[197]: SetEnum(v1: ref(reference), fld=0, val: boolean)
 153[184]: VarVector(var[160]) -> vector type=vector<Val>[4]:Vector(17)[19] var=_vec_3[160]:vector<Val>["__ref_2"]
 156[196]: VarRef(var[172]) -> ref(reference) type=boolean[1]:Base[4] var=_elm_4[172]:ref(boolean)["_vec_3"]
 159[208]: FinishRecord(data: ref(reference), rec: ref(reference), parent_tp=19, fld=65535)
 164[184]: VarVector(var[160]) -> vector type=vector<Val>[4]:Vector(17)[19] var=_vec_3[160]:vector<Val>["__ref_2"]
 167[196]: FreeStack(value=12, discard=36)
 171[172]: AppendVector(r: vector, other: vector, tp=17) type=Val[1]:Enum(["A", "B", "C"])[17]
 174[148]: VarVector(var[112]) -> vector type=vector<Val>[4]:Vector(17)[19] var=v[112]:vector<Val>["__ref_1"]
 177[160]: Database(var[4], db_tp=18) type=main_vector<Val>[8]:{vector:vector<Val>[4]}[18]
 182[160]: VarRef(var[4]) -> ref(reference) type=main_vector<Val>[8]:{vector:vector<Val>[4]}[18] var=__ref_3[4]:ref(main_vector<Val>)
 185[172]: GetField(v1: ref(reference), fld=4) -> ref(reference) type=vector<Val>[4]:Vector(17)[19]
 188[172]: VarRef(var[4]) -> ref(reference) type=main_vector<Val>[8]:{vector:vector<Val>[4]}[18] var=__ref_3[4]:ref(main_vector<Val>)
 191[184]: ConstInt(val=0) -> integer
 196[188]: SetInt(v1: ref(reference), fld=4, val: integer)
 199[172]: VarVector(var[160]) -> vector type=vector<Val>[4]:Vector(17)[19] var=_vec_5[160]:vector<Val>["__ref_3"]
 202[184]: NewRecord(data: ref(reference), parent_tp=19, fld=65535) -> ref(reference)
 207[184]: VarRef(var[172]) -> ref(reference) type=boolean[1]:Base[4] var=_elm_6[172]:ref(boolean)["_vec_5"]
 210[196]: ConstEnum(val=1) -> boolean type=Val[1]:Enum(["A", "B", "C"])[17]
 212[197]: SetEnum(v1: ref(reference), fld=0, val: boolean)
 215[184]: VarVector(var[160]) -> vector type=vector<Val>[4]:Vector(17)[19] var=_vec_5[160]:vector<Val>["__ref_3"]
 218[196]: VarRef(var[172]) -> ref(reference) type=boolean[1]:Base[4] var=_elm_6[172]:ref(boolean)["_vec_5"]
 221[208]: FinishRecord(data: ref(reference), rec: ref(reference), parent_tp=19, fld=65535)
 226[184]: VarVector(var[160]) -> vector type=vector<Val>[4]:Vector(17)[19] var=_vec_5[160]:vector<Val>["__ref_3"]
 229[196]: FreeStack(value=12, discard=36)
 233[172]: AppendVector(r: vector, other: vector, tp=17) type=Val[1]:Enum(["A", "B", "C"])[17]
 236[148]: ClearText(var[64]) var=__work_1[64]:text
 239[148]: ConstText(_value="") -> text
 241[164]: VarVector(var[112]) -> vector type=vector<Val>[4]:Vector(17)[19] var=v[112]:vector<Val>["__ref_1"]
 244[176]: FormatDatabase(var[64], val: ref(reference), db_tp=19, pretty=false)
 250[164]: VarText(var[64]) -> text var=__work_1[64]:text
 253[180]: FreeStack(value=16, discard=32)
 257[164]: FreeStack(value=16, discard=52)
 261[128]: AppendText(var[88], v1: text)
 264[112]: [5] VarText(var[88]) -> text var=test_value[88]:text["__work_1"]
 267[128]: ConstText(_value="[A,A,B,C,A]") -> text
 280[144]: EqText(v1: text, v2: text) -> boolean
 281[113]: GotoFalseWord(jump=287, if_false: boolean)
 284[112]: GotoWord(jump=346)
 287[112]: ClearText(var[40]) var=__work_2[40]:text
 290[112]: ConstText(_value="Test failed ") -> text
 304[128]: AppendText(var[40], v1: text)
 307[112]: VarText(var[88]) -> text var=test_value[88]:text["__work_1"]
 310[128]: ConstInt(val=0) -> integer
 315[132]: FormatText(var[40], val: text, width: integer, dir=-1, token=32)
 320[112]: ConstText(_value=" != "[A,A,B,C,A]"") -> text
 339[128]: AppendText(var[40], v1: text)
 342[112]: VarText(var[40]) -> text var=__work_2[40]:text
 345[128]: Panic(message: text)
 346[112]: FreeText(var[88])
 349[112]: VarRef(var[28]) -> ref(reference) type=main_vector<Val>[8]:{vector:vector<Val>[4]}[18] var=__ref_1[28]:ref(main_vector<Val>)
 352[124]: FreeRef(v1: ref(reference))
 353[112]: FreeText(var[64])
 356[112]: FreeText(var[40])
 359[112]: VarRef(var[16]) -> ref(reference) type=main_vector<Val>[8]:{vector:vector<Val>[4]}[18] var=__ref_2[16]:ref(main_vector<Val>)
 362[124]: FreeRef(v1: ref(reference))
 363[112]: VarRef(var[4]) -> ref(reference) type=main_vector<Val>[8]:{vector:vector<Val>[4]}[18] var=__ref_3[4]:ref(main_vector<Val>)
 366[124]: FreeRef(v1: ref(reference))
 367[112]: Return(ret=0, value=0, discard=112)

Execute test:
    0:[8] ConvRefFromNull() -> ref(1,0,0)[8]
    1:[20] ConvRefFromNull() -> ref(2,0,0)[20]
    2:[32] ConvRefFromNull() -> ref(3,0,0)[32]
    3:[44] Text()
    4:[68] [4] Text()
    5:[92] Text()
    6:[116] Database(var[32], db_tp=18)
   11:[116] VarRef(var[32]) -> ref(3,1,0)={}[116]
   14:[128] GetField(v1=ref(3,1,0)[116], fld=4) -> ref(3,1,4)=[][116]
   17:[128] VarRef(var[32]) -> ref(3,1,0)={}[128]
   20:[140] ConstInt(val=0) -> 0[140]
   25:[144] SetInt(v1=ref(3,1,0)[128], fld=4, val=0[140])
   28:[128] VarVector(var[116]) -> ref(3,1,4)=[][128]
   31:[140] NewRecord(data=ref(3,1,4)[128], parent_tp=19, fld=65535) -> ref(3,9,8)[128]
   36:[140] VarRef(var[128]) -> ref(3,9,8)=false[140]
   39:[152] ConstEnum(val=1) -> A(1)[152]
   41:[153] SetEnum(v1=ref(3,9,8)[140], fld=0, val=1[152])
   44:[140] VarVector(var[116]) -> ref(3,1,4)=[A][140]
   47:[152] VarRef(var[128]) -> ref(3,9,8)=true[152]
   50:[164] FinishRecord(data=ref(3,1,4)[140], rec=ref(3,9,8)[152], parent_tp=19, fld=65535)
   55:[140] VarVector(var[116]) -> ref(3,1,4)=[A][140]
   58:[152] NewRecord(data=ref(3,1,4)[140], parent_tp=19, fld=65535) -> ref(3,9,9)[140]
   63:[152] PutRef(var[128], value=ref(3,9,9)[140])
   66:[140] VarRef(var[128]) -> ref(3,9,9)=false[140]
   69:[152] ConstEnum(val=1) -> A(1)[152]
   71:[153] SetEnum(v1=ref(3,9,9)[140], fld=0, val=1[152])
   74:[140] VarVector(var[116]) -> ref(3,1,4)=[A,A][140]
   77:[152] VarRef(var[128]) -> ref(3,9,9)=true[152]
   80:[164] FinishRecord(data=ref(3,1,4)[140], rec=ref(3,9,9)[152], parent_tp=19, fld=65535)
   85:[140] VarVector(var[116]) -> ref(3,1,4)=[A,A][140]
   88:[152] NewRecord(data=ref(3,1,4)[140], parent_tp=19, fld=65535) -> ref(3,9,10)[140]
   93:[152] VarRef(var[140]) -> ref(3,9,10)=false[152]
   96:[164] ConstEnum(val=2) -> B(2)[164]
   98:[165] SetEnum(v1=ref(3,9,10)[152], fld=0, val=2[164])
  101:[152] VarVector(var[116]) -> ref(3,1,4)=[A,A,B][152]
  104:[164] VarRef(var[140]) -> ref(3,9,10)=true[164]
  107:[176] FinishRecord(data=ref(3,1,4)[152], rec=ref(3,9,10)[164], parent_tp=19, fld=65535)
  112:[152] VarVector(var[116]) -> ref(3,1,4)=[A,A,B][152]
  115:[164] Database(var[20], db_tp=18)
  120:[164] VarRef(var[20]) -> ref(2,1,0)={}[164]
  123:[176] GetField(v1=ref(2,1,0)[164], fld=4) -> ref(2,1,4)=[][164]
  126:[176] VarRef(var[20]) -> ref(2,1,0)={}[176]
  129:[188] ConstInt(val=0) -> 0[188]
  134:[192] SetInt(v1=ref(2,1,0)[176], fld=4, val=0[188])
  137:[176] VarVector(var[164]) -> ref(2,1,4)=[][176]
  140:[188] NewRecord(data=ref(2,1,4)[176], parent_tp=19, fld=65535) -> ref(2,9,8)[176]
  145:[188] VarRef(var[176]) -> ref(2,9,8)=false[188]
  148:[200] ConstEnum(val=3) -> C(3)[200]
  150:[201] SetEnum(v1=ref(2,9,8)[188], fld=0, val=3[200])
  153:[188] VarVector(var[164]) -> ref(2,1,4)=[C][188]
  156:[200] VarRef(var[176]) -> ref(2,9,8)=true[200]
  159:[212] FinishRecord(data=ref(2,1,4)[188], rec=ref(2,9,8)[200], parent_tp=19, fld=65535)
  164:[188] VarVector(var[164]) -> ref(2,1,4)=[C][188]
  167:[200] FreeStack(value=12, discard=36)
  171:[176] AppendVector(r=ref(3,1,4)[152], other=ref(2,1,4)[164], tp=17)
  174:[152] VarVector(var[116]) -> ref(3,1,4)=[A,A,B,C][152]
  177:[164] Database(var[8], db_tp=18)
  182:[164] VarRef(var[8]) -> ref(1,1,0)={}[164]
  185:[176] GetField(v1=ref(1,1,0)[164], fld=4) -> ref(1,1,4)=[][164]
  188:[176] VarRef(var[8]) -> ref(1,1,0)={}[176]
  191:[188] ConstInt(val=0) -> 0[188]
  196:[192] SetInt(v1=ref(1,1,0)[176], fld=4, val=0[188])
  199:[176] VarVector(var[164]) -> ref(1,1,4)=[][176]
  202:[188] NewRecord(data=ref(1,1,4)[176], parent_tp=19, fld=65535) -> ref(1,9,8)[176]
  207:[188] VarRef(var[176]) -> ref(1,9,8)=false[188]
  210:[200] ConstEnum(val=1) -> A(1)[200]
  212:[201] SetEnum(v1=ref(1,9,8)[188], fld=0, val=1[200])
  215:[188] VarVector(var[164]) -> ref(1,1,4)=[A][188]
  218:[200] VarRef(var[176]) -> ref(1,9,8)=true[200]
  221:[212] FinishRecord(data=ref(1,1,4)[188], rec=ref(1,9,8)[200], parent_tp=19, fld=65535)
  226:[188] VarVector(var[164]) -> ref(1,1,4)=[A][188]
  229:[200] FreeStack(value=12, discard=36)
  233:[176] AppendVector(r=ref(3,1,4)[152], other=ref(1,1,4)[164], tp=17)
  236:[152] ClearText(var[68])
  239:[152] ConstText(_value="") -> ""[152]
  241:[168] VarVector(var[116]) -> ref(3,1,4)=[A,A,B,C,A][168]
  244:[180] FormatDatabase(var[68], val=ref(3,1,4)[168], db_tp=19, pretty=false)
  250:[168] VarText(var[68]) -> "[A,A,B,C,A]"[168]
  253:[184] FreeStack(value=16, discard=32)
  257:[168] FreeStack(value=16, discard=52)
  261:[132] AppendText(var[92], v1="[A,A,B,C,A]"[116])
  264:[116] VarText(var[92]) -> "[A,A,B,C,A]"[116]
  267:[132] ConstText(_value="[A,A,B,C,A]") -> "[A,A,B,C,A]"[132]
  280:[148] EqText(v1="[A,A,B,C,A]"[116], v2="[A,A,B,C,A]"[132]) -> true[116]
  281:[117] GotoFalseWord(jump=287, if_false=true[116])
  284:[116] GotoWord(jump=346)
  346:[116] FreeText(var[92])
  349:[116] VarRef(var[32]) -> ref(3,1,0)={vector:[A,A,B,C,A]}[116]
  352:[128] FreeRef(v1=ref(3,1,0)[116])
  353:[116] FreeText(var[68])
  356:[116] FreeText(var[44])
  359:[116] VarRef(var[20]) -> ref(2,1,0)={vector:[C]}[116]
  362:[128] FreeRef(v1=ref(2,1,0)[116])
  363:[116] VarRef(var[8]) -> ref(1,1,0)={vector:[A]}[116]
  366:[128] FreeRef(v1=ref(1,1,0)[116])
  367:[116] Return(ret=4294967295[4], value=0, discard=112)
Finished
