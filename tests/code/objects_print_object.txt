struct Object{a: integer, bb: text, ccc: boolean}
fn obj() -> Object { Object {a: 12, bb: "hi", ccc: false } }

pub fn test() {
    test_value = {o = obj(); o.bb += '!'; "{o} pretty {o:#}"};
    assert(
        test_value == "{{a:12,bb:\"hi!\",ccc:false}} pretty {{ a: 12, bb: \"hi!\", ccc: false }}",
        "Test failed {test_value} != \"{{a:12,bb:\"hi!\",ccc:false}} pretty {{ a: 12, bb: \"hi!\", ccc: false }}\""
    );
}
Type 17:Object[9/4]:
    a:integer[0]
    bb:text[4]
    ccc:boolean[8]

fn n_obj() -> Object {#block(1):ref(Object)
  __ref_1(1):ref(Object) = null;
  [2] {#Object(2):ref(Object)["__ref_1"]
    OpDatabase(__ref_1(1), 17i32);
    OpSetInt(__ref_1(1), 0i32, 12i32);
    OpSetText(__ref_1(1), 4i32, "hi");
    OpSetByte(__ref_1(1), 8i32, 0i32, if false 1i32 else 0i32);
    __ref_1(1);
  }#Object(2):ref(Object)["__ref_1"];
}#block(1):ref(Object)

byte-code for print_object:n_obj() -> ref(Object)
   0[0]: return-address
   0[4]: ConvRefFromNull() -> ref(reference) var=__ref_1[4]:ref(Object)
   1[16]: [2] Database(var[4], db_tp=17) type=Object 17
   6[16]: VarRef(var[4]) -> ref(reference) type=Object 17 var=__ref_1[4]:ref(Object)
   9[28]: ConstInt(val=12) -> integer
  14[32]: SetInt(v1: ref(reference), fld=0, val: integer)
  17[16]: VarRef(var[4]) -> ref(reference) type=Object 17 var=__ref_1[4]:ref(Object)
  20[28]: ConstText(_value="hi") -> text
  24[44]: SetText(v1: ref(reference), fld=4, val: text)
  27[16]: VarRef(var[4]) -> ref(reference) type=Object 17 var=__ref_1[4]:ref(Object)
  30[28]: ConstFalse() -> boolean
  31[29]: GotoFalseWord(jump=42, if_false: boolean)
  34[28]: ConstInt(val=1) -> integer
  39[32]: GotoWord(jump=47)
  42[28]: ConstInt(val=0) -> integer
  47[32]: SetByte(v1: ref(reference), fld=8, min=0, val: integer)
  52[16]: VarRef(var[4]) -> ref(reference) type=Object 17 var=__ref_1[4]:ref(Object)
  55[28]: Return(ret=0, value=12, discard=28) type=Object 17

fn n_test() {#block(1):void
  __work_2(1):text = "";
  __work_1(1):text = "";
  [5] test_value(1):text["__work_1"] = {#block(2):text["__work_1"]
    o(2):ref(Object) = n_obj();
    _field_1(2):text = OpGetText(o(2), 4i32);
    OpAppendCharacter(_field_1(2), 33i32);
    OpSetText(o(2), 4i32, _field_1(2));
    {#Formatted string(3):text["__work_1"]
      __work_1(1):text = "";
      OpFormatDatabase(__work_1(1), o(2), 17i32, false);
      OpAppendText(__work_1(1), " pretty ");
      OpFormatDatabase(__work_1(1), o(2), 17i32, true);
      OpFreeRef(o(2));
      OpFreeText(_field_1(2));
      __work_1(1);
    }#Formatted string(3):text["__work_1"];
  }#block(2):text["__work_1"];
  [6] if OpEqText(test_value(1), "{a:12,bb:"hi!",ccc:false} pretty { a: 12, bb: "hi!", ccc: false }") null else OpPanic({#Formatted string(4):text["__work_2"]
    __work_2(1):text = "Test failed ";
    OpFormatText(__work_2(1), test_value(1), 0i32, -1i32, 32i32);
    OpAppendText(__work_2(1), " != "{a:12,bb:"hi!",ccc:false} pretty { a: 12, bb: "hi!", ccc: false }"");
    __work_2(1);
  }#Formatted string(4):text["__work_2"]);
  OpFreeText(test_value(1));
  OpFreeText(__work_1(1));
  OpFreeText(__work_2(1));
}#block(1):void

byte-code for print_object:n_test()
   0[0]: return-address
   0[4]: Text() var=__work_2[4]:text
   1[28]: Text() var=__work_1[28]:text
   2[52]: [5] Text() var=test_value[52]:text["__work_1"]
   3[76]: Call(size=0, fn=n_obj) var=o[76]:ref(Object)
  10[88]: Text() var=_field_1[88]:text
  11[112]: VarRef(var[76]) -> ref(reference) type=Object 17 var=o[76]:ref(Object)
  14[124]: GetText(v1: ref(reference), fld=4) -> text["test_value"]
  17[128]: AppendText(var[88], v1: text)
  20[112]: ConstInt(val=33) -> integer
  25[116]: AppendCharacter(var[88], v1: character)
  28[112]: VarRef(var[76]) -> ref(reference) type=Object 17 var=o[76]:ref(Object)
  31[124]: VarText(var[88]) -> text var=_field_1[88]:text
  34[140]: SetText(v1: ref(reference), fld=4, val: text)
  37[112]: ClearText(var[28]) var=__work_1[28]:text
  40[112]: ConstText(_value="") -> text
  42[128]: VarRef(var[76]) -> ref(reference) type=Object 17 var=o[76]:ref(Object)
  45[140]: FormatDatabase(var[28], val: ref(reference), db_tp=17, pretty=false)
  51[128]: ConstText(_value=" pretty ") -> text
  61[144]: AppendText(var[28], v1: text)
  64[128]: VarRef(var[76]) -> ref(reference) type=Object 17 var=o[76]:ref(Object)
  67[140]: FormatDatabase(var[28], val: ref(reference), db_tp=17, pretty=true)
  73[128]: VarRef(var[76]) -> ref(reference) type=Object 17 var=o[76]:ref(Object)
  76[140]: FreeRef(v1: ref(reference))
  77[128]: FreeText(var[88])
  80[128]: VarText(var[28]) -> text var=__work_1[28]:text
  83[144]: FreeStack(value=16, discard=32)
  87[128]: FreeStack(value=16, discard=52)
  91[92]: AppendText(var[52], v1: text)
  94[76]: [6] VarText(var[52]) -> text var=test_value[52]:text["__work_1"]
  97[92]: ConstText(_value="{a:12,bb:"hi!",ccc:false} pretty { a: 12, bb: "hi!", ccc: false }") -> text
 164[108]: EqText(v1: text, v2: text) -> boolean
 165[77]: GotoFalseWord(jump=171, if_false: boolean)
 168[76]: GotoWord(jump=284)
 171[76]: ClearText(var[4]) var=__work_2[4]:text
 174[76]: ConstText(_value="Test failed ") -> text
 188[92]: AppendText(var[4], v1: text)
 191[76]: VarText(var[52]) -> text var=test_value[52]:text["__work_1"]
 194[92]: ConstInt(val=0) -> integer
 199[96]: FormatText(var[4], val: text, width: integer, dir=-1, token=32)
 204[76]: ConstText(_value=" != "{a:12,bb:"hi!",ccc:false} pretty { a: 12, bb: "hi!", ccc: false }"") -> text
 277[92]: AppendText(var[4], v1: text)
 280[76]: VarText(var[4]) -> text var=__work_2[4]:text
 283[92]: Panic(message: text)
 284[76]: FreeText(var[52])
 287[76]: FreeText(var[28])
 290[76]: FreeText(var[4])
 293[76]: Return(ret=0, value=0, discard=76)

Execute test:
    0:[8] Text()
    1:[32] [5] Text()
    2:[56] Text()
    3:[80] Call(size=0, fn=n_obj)
 1103:[84] [2] ConvRefFromNull() -> ref(1,0,8)[84]
 1104:[96] Database(var[84], db_tp=17)
 1109:[96] VarRef(var[84]) -> ref(1,1,8)={ccc:false}[96]
 1112:[108] ConstInt(val=12) -> 12[108]
 1117:[112] SetInt(v1=ref(1,1,8)[96], fld=0, val=12[108])
 1120:[96] VarRef(var[84]) -> ref(1,1,8)={a:12,ccc:false}[96]
 1123:[108] ConstText(_value="hi") -> "hi"[108]
 1127:[124] SetText(v1=ref(1,1,8)[96], fld=4, val="hi"[108])
 1130:[96] VarRef(var[84]) -> ref(1,1,8)={a:12,bb:"hi",ccc:false}[96]
 1133:[108] ConstFalse() -> false[108]
 1134:[109] GotoFalseWord(jump=1145, if_false=false[108])
 1145:[108] ConstInt(val=0) -> 0[108]
 1150:[112] SetByte(v1=ref(1,1,8)[96], fld=8, min=0, val=0[108])
 1155:[96] VarRef(var[84]) -> ref(1,1,8)={a:12,bb:"hi",ccc:false}[96]
 1158:[108] Return(ret=1174[80], value=12, discard=28) -> ref(1,1,8)={a:12,bb:"hi",ccc:false}[80]
   10:[92] Text()
   11:[116] VarRef(var[80]) -> ref(1,1,8)={a:12,bb:"hi",ccc:false}[116]
   14:[128] GetText(v1=ref(1,1,8)[116], fld=4) -> "hi"[116]
   17:[132] AppendText(var[92], v1="hi"[116])
   20:[116] ConstInt(val=33) -> 33[116]
   25:[120] AppendCharacter(var[92], v1='!'[116])
   28:[116] VarRef(var[80]) -> ref(1,1,8)={a:12,bb:"hi",ccc:false}[116]
   31:[128] VarText(var[92]) -> "hi!"[128]
   34:[144] SetText(v1=ref(1,1,8)[116], fld=4, val="hi!"[128])
   37:[116] ClearText(var[32])
   40:[116] ConstText(_value="") -> ""[116]
   42:[132] VarRef(var[80]) -> ref(1,1,8)={a:12,bb:"hi!",ccc:false}[132]
   45:[144] FormatDatabase(var[32], val=ref(1,1,8)[132], db_tp=17, pretty=false)
   51:[132] ConstText(_value=" pretty ") -> " pretty "[132]
   61:[148] AppendText(var[32], v1=" pretty "[132])
   64:[132] VarRef(var[80]) -> ref(1,1,8)={a:12,bb:"hi!",ccc:false}[132]
   67:[144] FormatDatabase(var[32], val=ref(1,1,8)[132], db_tp=17, pretty=true)
   73:[132] VarRef(var[80]) -> ref(1,1,8)={a:12,bb:"hi!",ccc:false}[132]
   76:[144] FreeRef(v1=ref(1,1,8)[132])
   77:[132] FreeText(var[92])
   80:[132] VarText(var[32]) -> "{a:12,bb:\"hi!\",ccc:false} pretty { a: 12, bb: \"hi!\", ccc: false }"[132]
   83:[148] FreeStack(value=16, discard=32)
   87:[132] FreeStack(value=16, discard=52)
   91:[96] AppendText(var[56], v1="{a:12,bb:\"hi!\",ccc:false} pretty { a: 12, bb: \"hi!\", ccc: false }"[80])
   94:[80] VarText(var[56]) -> "{a:12,bb:\"hi!\",ccc:false} pretty { a: 12, bb: \"hi!\", ccc: false }"[80]
   97:[96] ConstText(_value="{a:12,bb:"hi!",ccc:false} pretty { a: 12, bb: "hi!", ccc: false }") -> "{a:12,bb:\"hi!\",ccc:false} pretty { a: 12, bb: \"hi!\", ccc: false }"[96]
  164:[112] EqText(v1="{a:12,bb:\"hi!\",ccc:false} pretty { a: 12, bb: \"hi!\", ccc: false }"[80], v2="{a:12,bb:\"hi!\",ccc:false} pretty { a: 12, bb: \"hi!\", ccc: false }"[96]) -> true[80]
  165:[81] GotoFalseWord(jump=171, if_false=true[80])
  168:[80] GotoWord(jump=284)
  284:[80] FreeText(var[56])
  287:[80] FreeText(var[32])
  290:[80] FreeText(var[8])
  293:[80] Return(ret=4294967295[4], value=0, discard=76)
Finished
