enum Content {
    Long { v: long },
    Float { v: float },
    Single { v: single },
    Text { v: text }
};

struct Container {
    name: text,
    content: Content,
    list: vector<Content>
}

fn fill() -> Container {
    Container {
        name: "testing",
        content: Single { v: 1234.56f },
        list: [
            Long { v: 9876543210l },
            Text { v: "An example sentence of text" },
            Float { v: 3.141592653589793 }
        ]
    }
}

pub fn test() {
    test_value = {c = fill(); "Container: {c:#}"};
    assert(
        test_value == "Container: {{ name: \"testing\",\n  content: Single {{ v: 1234.56 }},\n  list: [ Long {{ v: 9876543210 }}, Text {{ v: \"An example sentence of text\" }}, Float {{ v: 3.141592653589793 }} ]\n}}",
        "Test failed {test_value} != \"Container: {{ name: \"testing\",\n  content: Single {{ v: 1234.56 }},\n  list: [ Long {{ v: 9876543210 }}, Text {{ v: \"An example sentence of text\" }}, Float {{ v: 3.141592653589793 }} ]\n}}\""
    );
}
Type 17:Content[16/8]: parents [Container 22]
    Long:18
    Float:19
    Single:20
    Text:21

Type 18:Long[16/8]: EnumValue(1)
    enum:byte[0] default Long(1)
    v:long[8]

Type 19:Float[16/8]: EnumValue(2)
    enum:byte[0] default Long(2)
    v:float[8]

Type 20:Single[8/4]: EnumValue(3)
    enum:byte[0] default Long(3)
    v:single[4]

Type 21:Text[8/4]: EnumValue(4)
    enum:byte[0] default Long(4)
    v:text[4]

Type 22:Container[24/8]:
    name:text[16]
    content:Content[0]
    list:vector<Content>[20]

Type 23:vector<Content>[4/4]:Vector(17)

fn fill() -> Container {#block(1):ref(Container)
  __ref_1(1):ref(Container) = null;
  [15] {#Object(2):ref(Container)["__ref_1"]
    OpDatabase(__ref_1(1), 22i32);
    OpSetText(__ref_1(1), 16i32, "testing");
    drop OpNewRecord(__ref_1(1), 20i32, 0i32);
    OpSetSingle(__ref_1(1), 4i32, 1234.56f32);
    OpSetInt(__ref_1(1), 20i32, 0i32);
    _elm_2(65535):ref(boolean)["__ref_1"] = OpNewRecord(__ref_1(1), 22i32, 2i32);
    OpSetLong(_elm_2(65535), 8i32, 9876543210i64);
    OpSetEnum(_elm_2(65535), 0i32, 1u8(17));
    OpFinishRecord(__ref_1(1), _elm_2(65535), 22i32, 2i32);
    _elm_2(65535):ref(boolean)["__ref_1"] = OpNewRecord(__ref_1(1), 22i32, 2i32);
    OpSetText(_elm_2(65535), 4i32, "An example sentence of text");
    OpSetEnum(_elm_2(65535), 0i32, 4u8(17));
    OpFinishRecord(__ref_1(1), _elm_2(65535), 22i32, 2i32);
    _elm_2(65535):ref(boolean)["__ref_1"] = OpNewRecord(__ref_1(1), 22i32, 2i32);
    OpSetFloat(_elm_2(65535), 8i32, 3.141592653589793f64);
    OpSetEnum(_elm_2(65535), 0i32, 2u8(17));
    OpFinishRecord(__ref_1(1), _elm_2(65535), 22i32, 2i32);
    __ref_1(1);
  }#Object(2):ref(Container)["__ref_1"];
}#block(1):ref(Container)

byte-code for enum_field:fill() -> ref(Container)
   0[0]: return-address
   0[4]: ConvRefFromNull() -> ref(reference) var=__ref_1[4]:ref(Container)
   1[16]: [15] Database(var[4], db_tp=22) type=Container 22
   6[16]: VarRef(var[4]) -> ref(reference) type=Container 22 var=__ref_1[4]:ref(Container)
   9[28]: ConstText(_value="testing") -> text
  18[44]: SetText(v1: ref(reference), fld=16, val: text)
  21[16]: VarRef(var[4]) -> ref(reference) type=Container 22 var=__ref_1[4]:ref(Container)
  24[28]: NewRecord(data: ref(reference), parent_tp=20, fld=0) -> ref(reference)
  29[28]: FreeStack(value=0, discard=12)
  33[16]: VarRef(var[4]) -> ref(reference) type=Container 22 var=__ref_1[4]:ref(Container)
  36[28]: ConstSingle(val=1234.56) -> single
  41[32]: SetSingle(v1: ref(reference), fld=4, val: single)
  44[16]: VarRef(var[4]) -> ref(reference) type=Container 22 var=__ref_1[4]:ref(Container)
  47[28]: ConstInt(val=0) -> integer
  52[32]: SetInt(v1: ref(reference), fld=20, val: integer)
  55[16]: VarRef(var[4]) -> ref(reference) type=Container 22 var=__ref_1[4]:ref(Container)
  58[28]: NewRecord(data: ref(reference), parent_tp=22, fld=2) -> ref(reference)
  63[28]: VarRef(var[16]) -> ref(reference) type=boolean 4 var=_elm_2[16]:ref(boolean)["__ref_1"]
  66[40]: ConstLong(val=9876543210) -> long
  75[48]: SetLong(v1: ref(reference), fld=8, val: long)
  78[28]: VarRef(var[16]) -> ref(reference) type=boolean 4 var=_elm_2[16]:ref(boolean)["__ref_1"]
  81[40]: ConstEnum(val=1) -> boolean type=Content 17
  83[41]: SetEnum(v1: ref(reference), fld=0, val: boolean)
  86[28]: VarRef(var[4]) -> ref(reference) type=Container 22 var=__ref_1[4]:ref(Container)
  89[40]: VarRef(var[16]) -> ref(reference) type=boolean 4 var=_elm_2[16]:ref(boolean)["__ref_1"]
  92[52]: FinishRecord(data: ref(reference), rec: ref(reference), parent_tp=22, fld=2)
  97[28]: VarRef(var[4]) -> ref(reference) type=Container 22 var=__ref_1[4]:ref(Container)
 100[40]: NewRecord(data: ref(reference), parent_tp=22, fld=2) -> ref(reference)
 105[40]: PutRef(var[16], value: ref(reference))
 108[28]: VarRef(var[16]) -> ref(reference) type=boolean 4 var=_elm_2[16]:ref(boolean)["__ref_1"]
 111[40]: ConstText(_value="An example sentence of text") -> text
 140[56]: SetText(v1: ref(reference), fld=4, val: text)
 143[28]: VarRef(var[16]) -> ref(reference) type=boolean 4 var=_elm_2[16]:ref(boolean)["__ref_1"]
 146[40]: ConstEnum(val=4) -> boolean type=Content 17
 148[41]: SetEnum(v1: ref(reference), fld=0, val: boolean)
 151[28]: VarRef(var[4]) -> ref(reference) type=Container 22 var=__ref_1[4]:ref(Container)
 154[40]: VarRef(var[16]) -> ref(reference) type=boolean 4 var=_elm_2[16]:ref(boolean)["__ref_1"]
 157[52]: FinishRecord(data: ref(reference), rec: ref(reference), parent_tp=22, fld=2)
 162[28]: VarRef(var[4]) -> ref(reference) type=Container 22 var=__ref_1[4]:ref(Container)
 165[40]: NewRecord(data: ref(reference), parent_tp=22, fld=2) -> ref(reference)
 170[40]: PutRef(var[16], value: ref(reference))
 173[28]: VarRef(var[16]) -> ref(reference) type=boolean 4 var=_elm_2[16]:ref(boolean)["__ref_1"]
 176[40]: ConstFloat(val=3.141592653589793) -> float
 185[48]: SetFloat(v1: ref(reference), fld=8, val: float)
 188[28]: VarRef(var[16]) -> ref(reference) type=boolean 4 var=_elm_2[16]:ref(boolean)["__ref_1"]
 191[40]: ConstEnum(val=2) -> boolean type=Content 17
 193[41]: SetEnum(v1: ref(reference), fld=0, val: boolean)
 196[28]: VarRef(var[4]) -> ref(reference) type=Container 22 var=__ref_1[4]:ref(Container)
 199[40]: VarRef(var[16]) -> ref(reference) type=boolean 4 var=_elm_2[16]:ref(boolean)["__ref_1"]
 202[52]: FinishRecord(data: ref(reference), rec: ref(reference), parent_tp=22, fld=2)
 207[28]: VarRef(var[4]) -> ref(reference) type=Container 22 var=__ref_1[4]:ref(Container)
 210[40]: FreeStack(value=12, discard=24)
 214[28]: Return(ret=0, value=12, discard=28) type=Container 22

fn test() {#block(1):void
  __work_2(1):text = "";
  __work_1(1):text = "";
  [27] test_value(1):text["__work_1"] = {#block(2):text["__work_1"]
    c(2):ref(Container) = fill();
    {#Formatted string(3):text["__work_1"]
      __work_1(1):text = "Container: ";
      OpFormatDatabase(__work_1(1), c(2), 22i32, true);
      OpFreeRef(c(2));
      __work_1(1);
    }#Formatted string(3):text["__work_1"];
  }#block(2):text["__work_1"];
  [28] if OpEqText(test_value(1), "Container: { name: "testing",
  content: Single { v: 1234.56 },
  list: [ Long { v: 9876543210 }, Text { v: "An example sentence of text" }, Float { v: 3.141592653589793 } ]
}") null else OpPanic({#Formatted string(4):text["__work_2"]
    __work_2(1):text = "Test failed ";
    OpFormatText(__work_2(1), test_value(1), 0i32, -1i32, 32i32);
    OpAppendText(__work_2(1), " != "Container: { name: "testing",
  content: Single { v: 1234.56 },
  list: [ Long { v: 9876543210 }, Text { v: "An example sentence of text" }, Float { v: 3.141592653589793 } ]
}"");
    __work_2(1);
  }#Formatted string(4):text["__work_2"]);
  OpFreeText(test_value(1));
  OpFreeText(__work_1(1));
  OpFreeText(__work_2(1));
}#block(1):void

byte-code for enum_field:test()
   0[0]: return-address
   0[4]: Text() var=__work_2[4]:text
   1[28]: Text() var=__work_1[28]:text
   2[52]: [27] Text() var=test_value[52]:text["__work_1"]
   3[76]: Call(size=0, fn=fill) var=c[76]:ref(Container)
  10[88]: ClearText(var[28]) var=__work_1[28]:text
  13[88]: ConstText(_value="Container: ") -> text
  26[104]: AppendText(var[28], v1: text)
  29[88]: VarRef(var[76]) -> ref(reference) type=Container 22 var=c[76]:ref(Container)
  32[100]: FormatDatabase(var[28], val: ref(reference), db_tp=22, pretty=true)
  38[88]: VarRef(var[76]) -> ref(reference) type=Container 22 var=c[76]:ref(Container)
  41[100]: FreeRef(v1: ref(reference))
  42[88]: VarText(var[28]) -> text var=__work_1[28]:text
  45[104]: FreeStack(value=16, discard=28)
  49[92]: AppendText(var[52], v1: text)
  52[76]: [28] VarText(var[52]) -> text var=test_value[52]:text["__work_1"]
  55[92]: ConstText(_value="Container: { name: "testing",
  content: Single { v: 1234.56 },
  list: [ Long { v: 9876543210 }, Text { v: "An example sentence of text" }, Float { v: 3.141592653589793 } ]
}") -> text
 232[108]: EqText(v1: text, v2: text) -> boolean
 233[77]: GotoFalseWord(jump=239, if_false: boolean)
 236[76]: GotoWord(jump=462)
 239[76]: ClearText(var[4]) var=__work_2[4]:text
 242[76]: ConstText(_value="Test failed ") -> text
 256[92]: AppendText(var[4], v1: text)
 259[76]: VarText(var[52]) -> text var=test_value[52]:text["__work_1"]
 262[92]: ConstInt(val=0) -> integer
 267[96]: FormatText(var[4], val: text, width: integer, dir=-1, token=32)
 272[76]: ConstText(_value=" != "Container: { name: "testing",
  content: Single { v: 1234.56 },
  list: [ Long { v: 9876543210 }, Text { v: "An example sentence of text" }, Float { v: 3.141592653589793 } ]
}"") -> text
 455[92]: AppendText(var[4], v1: text)
 458[76]: VarText(var[4]) -> text var=__work_2[4]:text
 461[92]: Panic(message: text)
 462[76]: FreeText(var[52])
 465[76]: FreeText(var[28])
 468[76]: FreeText(var[4])
 471[76]: Return(ret=0, value=0, discard=76)

Execute test:
    0:[8] Text()
    1:[32] [27] Text()
    2:[56] Text()
    3:[80] Call(size=0, fn=fill)
 1103:[84] [15] ConvRefFromNull() -> ref(1,0,8)[84]
 1104:[96] Database(var[84], db_tp=22)
 1109:[96] VarRef(var[84]) -> ref(1,1,8)={}[96]
 1112:[108] ConstText(_value="testing") -> "testing"[108]
 1121:[124] SetText(v1=ref(1,1,8)[96], fld=16, val="testing"[108])
 1124:[96] VarRef(var[84]) -> ref(1,1,8)={name:"testing"}[96]
 1127:[108] NewRecord(data=ref(1,1,8)[96], parent_tp=20, fld=0) -> ref(1,1,8)[96]
 1132:[108] FreeStack(value=0, discard=12)
 1136:[96] VarRef(var[84]) -> ref(1,1,8)={name:"testing",content:Single {}}[96]
 1139:[108] ConstSingle(val=1234.56) -> 1234.56[108]
 1144:[112] SetSingle(v1=ref(1,1,8)[96], fld=4, val=1234.56[108])
 1147:[96] VarRef(var[84]) -> ref(1,1,8)={name:"testing",content:Single {v:1234.56}}[96]
 1150:[108] ConstInt(val=0) -> 0[108]
 1155:[112] SetInt(v1=ref(1,1,8)[96], fld=20, val=0[108])
 1158:[96] VarRef(var[84]) -> ref(1,1,8)={name:"testing",content:Single {v:1234.56}}[96]
 1161:[108] NewRecord(data=ref(1,1,8)[96], parent_tp=22, fld=2) -> ref(1,27,8)[96]
 1166:[108] VarRef(var[96]) -> ref(1,27,8)=false[108]
 1169:[120] ConstLong(val=9876543210) -> 9876543210[120]
 1178:[128] SetLong(v1=ref(1,27,8)[108], fld=8, val=9876543210[120])
 1181:[108] VarRef(var[96]) -> ref(1,27,8)=false[108]
 1184:[120] ConstEnum(val=1) -> Long(1)[120]
 1186:[121] SetEnum(v1=ref(1,27,8)[108], fld=0, val=1[120])
 1189:[108] VarRef(var[84]) -> ref(1,1,8)={name:"testing",content:Single {v:1234.56},list:[]}[108]
 1192:[120] VarRef(var[96]) -> ref(1,27,8)=true[120]
 1195:[132] FinishRecord(data=ref(1,1,8)[108], rec=ref(1,27,8)[120], parent_tp=22, fld=2)
 1200:[108] VarRef(var[84]) -> ref(1,1,8)={name:"testing",content:Single {v:1234.56},list:[Long {v:9876543210}]}[108]
 1203:[120] NewRecord(data=ref(1,1,8)[108], parent_tp=22, fld=2) -> ref(1,27,24)[108]
 1208:[120] PutRef(var[96], value=ref(1,27,24)[108])
 1211:[108] VarRef(var[96]) -> ref(1,27,24)=false[108]
 1214:[120] ConstText(_value="An example sentence of text") -> "An example sentence of text"[120]
 1243:[136] SetText(v1=ref(1,27,24)[108], fld=4, val="An example sentence of text"[120])
 1246:[108] VarRef(var[96]) -> ref(1,27,24)=false[108]
 1249:[120] ConstEnum(val=4) -> Text(4)[120]
 1251:[121] SetEnum(v1=ref(1,27,24)[108], fld=0, val=4[120])
 1254:[108] VarRef(var[84]) -> ref(1,1,8)={name:"testing",content:Single {v:1234.56},list:[Long {v:9876543210}]}[108]
 1257:[120] VarRef(var[96]) -> ref(1,27,24)=true[120]
 1260:[132] FinishRecord(data=ref(1,1,8)[108], rec=ref(1,27,24)[120], parent_tp=22, fld=2)
 1265:[108] VarRef(var[84]) -> ref(1,1,8)={name:"testing",content:Single {v:1234.56},list:[Long {v:9876543210},Text {v:"An example sentence of text"}]}[108]
 1268:[120] NewRecord(data=ref(1,1,8)[108], parent_tp=22, fld=2) -> ref(1,27,40)[108]
 1273:[120] PutRef(var[96], value=ref(1,27,40)[108])
 1276:[108] VarRef(var[96]) -> ref(1,27,40)=false[108]
 1279:[120] ConstFloat(val=3.141592653589793) -> 3.141592653589793[120]
 1288:[128] SetFloat(v1=ref(1,27,40)[108], fld=8, val=3.141592653589793[120])
 1291:[108] VarRef(var[96]) -> ref(1,27,40)=false[108]
 1294:[120] ConstEnum(val=2) -> Float(2)[120]
 1296:[121] SetEnum(v1=ref(1,27,40)[108], fld=0, val=2[120])
 1299:[108] VarRef(var[84]) -> ref(1,1,8)={name:"testing",content:Single {v:1234.56},list:[Long {v:9876543210},Text {v:"An example sentence of text"}]}[108]
 1302:[120] VarRef(var[96]) -> ref(1,27,40)=true[120]
 1305:[132] FinishRecord(data=ref(1,1,8)[108], rec=ref(1,27,40)[120], parent_tp=22, fld=2)
 1310:[108] VarRef(var[84]) -> ref(1,1,8)={name:"testing",content:Single {v:1234.56},list:[Long {v:9876543210},Text {v:"An example sentence of text"},Float {v:3.141592653589793}]}[108]
 1313:[120] FreeStack(value=12, discard=24)
 1317:[108] Return(ret=1333[80], value=12, discard=28) -> ref(1,1,8)={name:"testing",content:Single {v:1234.56},list:[Long {v:9876543210},Text {v:"An example sentence of text"},Float {v:3.141592653589793}]}[80]
   10:[92] ClearText(var[32])
   13:[92] ConstText(_value="Container: ") -> "Container: "[92]
   26:[108] AppendText(var[32], v1="Container: "[92])
   29:[92] VarRef(var[80]) -> ref(1,1,8)={name:"testing",content:Single {v:1234.56},list:[Long {v:9876543210},Text {v:"An example sentence of text"},Float {v:3.141592653589793}]}[92]
   32:[104] FormatDatabase(var[32], val=ref(1,1,8)[92], db_tp=22, pretty=true)
   38:[92] VarRef(var[80]) -> ref(1,1,8)={name:"testing",content:Single {v:1234.56},list:[Long {v:9876543210},Text {v:"An example sentence of text"},Float {v:3.141592653589793}]}[92]
   41:[104] FreeRef(v1=ref(1,1,8)[92])
   42:[92] VarText(var[32]) -> "Container: { name: \"testing\",
  content: Single { v: 1234.56 },
  list: [ Long { v: 9876543210 }, Text { v: \"An example sentence of text\" }, Float { v: 3.141592653589793 } ]
}"[92]
   45:[108] FreeStack(value=16, discard=28)
   49:[96] AppendText(var[56], v1="Container: { name: \"testing\",
  content: Single { v: 1234.56 },
  list: [ Long { v: 9876543210 }, Text { v: \"An example sentence of text\" }, Float { v: 3.141592653589793 } ]
}"[80])
   52:[80] VarText(var[56]) -> "Container: { name: \"testing\",
  content: Single { v: 1234.56 },
  list: [ Long { v: 9876543210 }, Text { v: \"An example sentence of text\" }, Float { v: 3.141592653589793 } ]
}"[80]
   55:[96] ConstText(_value="Container: { name: "testing",
  content: Single { v: 1234.56 },
  list: [ Long { v: 9876543210 }, Text { v: "An example sentence of text" }, Float { v: 3.141592653589793 } ]
}") -> "Container: { name: \"testing\",
  content: Single { v: 1234.56 },
  list: [ Long { v: 9876543210 }, Text { v: \"An example sentence of text\" }, Float { v: 3.141592653589793 } ]
}"[96]
  232:[112] EqText(v1="Container: { name: \"testing\",
  content: Single { v: 1234.56 },
  list: [ Long { v: 9876543210 }, Text { v: \"An example sentence of text\" }, Float { v: 3.141592653589793 } ]
}"[80], v2="Container: { name: \"testing\",
  content: Single { v: 1234.56 },
  list: [ Long { v: 9876543210 }, Text { v: \"An example sentence of text\" }, Float { v: 3.141592653589793 } ]
}"[96]) -> true[80]
  233:[81] GotoFalseWord(jump=239, if_false=true[80])
  236:[80] GotoWord(jump=462)
  462:[80] FreeText(var[56])
  465:[80] FreeText(var[32])
  468:[80] FreeText(var[8])
  471:[80] Return(ret=4294967295[4], value=0, discard=76)
Finished
