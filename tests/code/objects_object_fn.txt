pub struct Data {
    name: text,
    number: integer
}

fn data(n: text) -> Data {
    res = Data { name: n };
    res
}
    

pub fn test() {
    test_value = {d = data("test"); "{d.name}:{d.number}"};
    assert(
        test_value == "test:0",
        "Test failed {test_value} != \"test:0\""
    );
}
Type 17:Data[12]:
    name:text[4]
    number:integer[8]

fn data(n:text, res:Data) -> Data["res"] {#block(1):ref(Data)["res"]
  [7] OpDatabase(res(0), 17i32);
  OpSetText(res(0), 4i32, n(0));
  OpSetInt(res(0), 8i32, 0i32);
  [8] res(0);
}#block(1):ref(Data)["res"]

byte-code for object_fn:data(n: text[0], res: ref(Data)[16]) -> ref(Data)["res"]
   0[28]: return-address
   0[32]: [7] Database(var[16], db_tp=17) type=Data[12]:{name:text[4], number:integer[8]}[17]
   5[32]: VarRef(var[16]) -> ref(reference) type=Data[12]:{name:text[4], number:integer[8]}[17] var=res[16]:ref(Data)
   8[44]: ArgText(var[0]) -> text var=n[0]:text
  11[60]: SetText(v1: ref(reference), fld=4, val: text)
  14[32]: VarRef(var[16]) -> ref(reference) type=Data[12]:{name:text[4], number:integer[8]}[17] var=res[16]:ref(Data)
  17[44]: ConstInt(val=0) -> integer
  22[48]: SetInt(v1: ref(reference), fld=8, val: integer)
  25[32]: [8] VarRef(var[16]) -> ref(reference) type=Data[12]:{name:text[4], number:integer[8]}[17] var=res[16]:ref(Data)
  28[44]: Return(ret=28, value=12, discard=44) type=Data[12]:{name:text[4], number:integer[8]}[17]

fn test() {#block(1):void
  __ref_1(1):ref(Data) = null;
  __work_2(1):text = "";
  __work_1(1):text = "";
  [13] test_value(1):text["__work_1"] = {#block(2):text["__work_1"]
    d(2):ref(Data)["__ref_1"] = data("test", __ref_1(1));
    {#Formatted string(3):text["__work_1"]
      __work_1(1):text = "";
      OpFormatText(__work_1(1), OpGetText(d(2), 4i32), 0i32, -1i32, 32i32);
      OpAppendText(__work_1(1), ":");
      OpFormatLong(__work_1(1), OpConvLongFromInt(OpGetInt(d(2), 8i32)), 10i32, 0i32, 32i32, false, false);
      __work_1(1);
    }#Formatted string(3):text["__work_1"];
  }#block(2):text["__work_1"];
  [14] if OpEqText(test_value(1), "test:0") null else OpPanic({#Formatted string(4):text["__work_2"]
    __work_2(1):text = "Test failed ";
    OpFormatText(__work_2(1), test_value(1), 0i32, -1i32, 32i32);
    OpAppendText(__work_2(1), " != "test:0"");
    __work_2(1);
  }#Formatted string(4):text["__work_2"]);
  OpFreeText(test_value(1));
  OpFreeRef(__ref_1(1));
  OpFreeText(__work_1(1));
  OpFreeText(__work_2(1));
}#block(1):void

byte-code for object_fn:test()
   0[0]: return-address
   0[4]: ConvRefFromNull() -> ref(reference) var=__ref_1[4]:ref(Data)
   1[16]: Text() var=__work_2[16]:text
   2[40]: Text() var=__work_1[40]:text
   3[64]: [13] Text() var=test_value[64]:text["__work_1"]
   4[88]: ConstText(_value="test") -> text var=d[88]:ref(Data)["__ref_1"]
  10[104]: VarRef(var[4]) -> ref(reference) type=Data[12]:{name:text[4], number:integer[8]}[17] var=__ref_1[4]:ref(Data)
  13[116]: Call(size=0, fn=data)
  20[100]: ClearText(var[40]) var=__work_1[40]:text
  23[100]: ConstText(_value="") -> text
  25[116]: VarRef(var[88]) -> ref(reference) type=Data[12]:{name:text[4], number:integer[8]}[17] var=d[88]:ref(Data)["__ref_1"]
  28[128]: GetText(v1: ref(reference), fld=4) -> text["test_value"]
  31[132]: ConstInt(val=0) -> integer
  36[136]: FormatText(var[40], val: text, width: integer, dir=-1, token=32)
  41[116]: ConstText(_value=":") -> text
  44[132]: AppendText(var[40], v1: text)
  47[116]: VarRef(var[88]) -> ref(reference) type=Data[12]:{name:text[4], number:integer[8]}[17] var=d[88]:ref(Data)["__ref_1"]
  50[128]: GetInt(v1: ref(reference), fld=8) -> integer
  53[120]: ConvLongFromInt(v1: integer) -> long
  54[124]: ConstInt(val=0) -> integer
  59[128]: FormatLong(var[40], val: long, radix=10, width: integer, token=32, plus=false, note=false)
  66[116]: VarText(var[40]) -> text var=__work_1[40]:text
  69[132]: FreeStack(value=16, discard=32)
  73[116]: FreeStack(value=16, discard=28)
  77[104]: AppendText(var[64], v1: text)
  80[88]: [14] VarText(var[64]) -> text var=test_value[64]:text["__work_1"]
  83[104]: ConstText(_value="test:0") -> text
  91[120]: EqText(v1: text, v2: text) -> boolean
  92[89]: GotoFalseWord(jump=98, if_false: boolean)
  95[88]: GotoWord(jump=152)
  98[88]: ClearText(var[16]) var=__work_2[16]:text
 101[88]: ConstText(_value="Test failed ") -> text
 115[104]: AppendText(var[16], v1: text)
 118[88]: VarText(var[64]) -> text var=test_value[64]:text["__work_1"]
 121[104]: ConstInt(val=0) -> integer
 126[108]: FormatText(var[16], val: text, width: integer, dir=-1, token=32)
 131[88]: ConstText(_value=" != "test:0"") -> text
 145[104]: AppendText(var[16], v1: text)
 148[88]: VarText(var[16]) -> text var=__work_2[16]:text
 151[104]: Panic(message: text)
 152[88]: FreeText(var[64])
 155[88]: VarRef(var[4]) -> ref(reference) type=Data[12]:{name:text[4], number:integer[8]}[17] var=__ref_1[4]:ref(Data)
 158[100]: FreeRef(v1: ref(reference))
 159[88]: FreeText(var[40])
 162[88]: FreeText(var[16])
 165[88]: Return(ret=0, value=0, discard=88)

Execute test:
    0:[8] ConvRefFromNull() -> ref(1,0,0)[8]
    1:[20] Text()
    2:[44] [13] Text()
    3:[68] Text()
    4:[92] ConstText(_value="test") -> "test"[92]
   10:[108] VarRef(var[8]) -> ref(1,0,0)=null[108]
   13:[120] Call(size=0, fn=data)
 1103:[124] Database(var[108], db_tp=17)
 1108:[124] VarRef(var[108]) -> ref(1,1,0)={}[124]
 1111:[136] ArgText(var[92]) -> "test"[136]
 1114:[152] SetText(v1=ref(1,1,0)[124], fld=4, val="test"[136])
 1117:[124] VarRef(var[108]) -> ref(1,1,0)={name:"test"}[124]
 1120:[136] ConstInt(val=0) -> 0[136]
 1125:[140] SetInt(v1=ref(1,1,0)[124], fld=8, val=0[136])
 1128:[124] VarRef(var[108]) -> ref(1,1,0)={name:"test",number:0}[124]
 1131:[136] Return(ret=1157[120], value=12, discard=44) -> ref(1,1,0)={name:"test",number:0}[92]
   20:[104] ClearText(var[44])
   23:[104] ConstText(_value="") -> ""[104]
   25:[120] VarRef(var[92]) -> ref(1,1,0)={name:"test",number:0}[120]
   28:[132] GetText(v1=ref(1,1,0)[120], fld=4) -> "test"[120]
   31:[136] ConstInt(val=0) -> 0[136]
   36:[140] FormatText(var[44], val="test"[120], width=0[136], dir=-1, token=32)
   41:[120] ConstText(_value=":") -> ":"[120]
   44:[136] AppendText(var[44], v1=":"[120])
   47:[120] VarRef(var[92]) -> ref(1,1,0)={name:"test",number:0}[120]
   50:[132] GetInt(v1=ref(1,1,0)[120], fld=8) -> 0[120]
   53:[124] ConvLongFromInt(v1=0[120]) -> 0[120]
   54:[128] ConstInt(val=0) -> 0[128]
   59:[132] FormatLong(var[44], val=0[120], radix=10, width=0[128], token=32, plus=false, note=false)
   66:[120] VarText(var[44]) -> "test:0"[120]
   69:[136] FreeStack(value=16, discard=32)
   73:[120] FreeStack(value=16, discard=28)
   77:[108] AppendText(var[68], v1="test:0"[92])
   80:[92] VarText(var[68]) -> "test:0"[92]
   83:[108] ConstText(_value="test:0") -> "test:0"[108]
   91:[124] EqText(v1="test:0"[92], v2="test:0"[108]) -> true[92]
   92:[93] GotoFalseWord(jump=98, if_false=true[92])
   95:[92] GotoWord(jump=152)
  152:[92] FreeText(var[68])
  155:[92] VarRef(var[8]) -> ref(1,0,0)=null[92]
  158:[104] FreeRef(v1=ref(1,0,0)[92])
  159:[92] FreeText(var[44])
  162:[92] FreeText(var[20])
  165:[92] Return(ret=4294967295[4], value=0, discard=88)
Finished
